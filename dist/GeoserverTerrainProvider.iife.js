var GeoserverTerrainProvider=function(e,t){"use strict";var r=Object.defineProperty,i=(e,t,i)=>((e,t,i)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i);function l(e,r){const i=Math.max(e.west,r.west),l=Math.min(e.east,r.east),a=Math.max(e.south,r.south),o=Math.min(e.north,r.north);let n;return n=l<=i||a>=o?null:new t.Rectangle(i,a,l,o),n}const a=[{name:"CRS:84",ellipsoid:t.Ellipsoid.WGS84,firstAxeIsLatitude:!1,tilingScheme:t.GeographicTilingScheme,supportedCRS:"urn:ogc:def:crs:OGC:2:84"},{name:"EPSG:4326",ellipsoid:t.Ellipsoid.WGS84,firstAxeIsLatitude:!0,tilingScheme:t.GeographicTilingScheme,supportedCRS:"urn:ogc:def:crs:EPSG::4326"},{name:"EPSG:3857",ellipsoid:t.Ellipsoid.WGS84,firstAxeIsLatitude:!1,tilingScheme:t.WebMercatorTilingScheme,supportedCRS:"urn:ogc:def:crs:EPSG::3857"},{name:"OSGEO:41001",ellipsoid:t.Ellipsoid.WGS84,firstAxeIsLatitude:!1,tilingScheme:t.WebMercatorTilingScheme,supportedCRS:"urn:ogc:def:crs:EPSG::3857"}],o=[{format:"image/png",extension:"png"},{format:"image/jpeg",extension:"jpg"},{format:"image/jpeg",extension:"jpeg"},{format:"image/gif",extension:"gif"},{format:"image/png; mode=8bit",extension:"png"}],n=[{format:"image/bil",postProcessArray:function(e,t,r,i,l){let a=null;const o=new DataView(e),n=new ArrayBuffer(t.height*t.width*2),s=new DataView(n);if(n.byteLength===e.byteLength){let e,t=0,h=0;for(let a=0;a<n.byteLength;a+=2)if(e=o.getInt16(a,!1)-l,e>i&&e<r)s.setInt16(a,e,!0),h+=e,t++;else{const e=0===t?1:h/t;s.setInt16(a,e,!0)}a=new Int16Array(n)}return a}}],s={service:"WMS",maxLevel:11,heightMapWidth:65,heightMapHeight:65,offset:0,highest:12e3,lowest:-500,hasStyledImage:!1},h={heightScale:1,heightOffset:0,elementsPerHeight:1,stride:1,elementMultiplier:256,isBigEndian:!1,lowestEncodedHeight:0,highestEncodedHeight:1e4};function m(e,t){t.heightMapWidth=e.heightMapWidth,t.heightMapHeight=e.heightMapHeight,t.ready=!1,t.maximumLevel=e.maxLevel,t.levelZeroMaximumGeometricError=void 0,t.offset=e.offset,t.highest=e.highest,t.lowest=e.lowest,t.hasStyledImage=e.hasStyledImage||"string"==typeof e.styleName}const{fetchXML:g}=t.Resource;async function c(e){const t=e.xml;if(!(t instanceof XMLDocument))throw new Error("xml must be a XMLDocument");let r;if(null!==t.querySelector("TileMapService")){if(!e.layerName)throw new Error("layerName is required.");const i=Array.from(t.querySelectorAll("TileMap[title='"+e.layerName+"']")).map((t=>{let r=t.getAttribute("href");return e.proxy&&(r=e.proxy.getURL(r)),g({url:r}).then((t=>(e.xml=t,u(e))))}));r=await Promise.race(i)}else r=u(e);return r}function u(e){const r=e.xml;let i={};m(e,i);const n=e.maxLevel,s=e.proxy,h=r.querySelector("SRS").textContent,g=a.find((e=>e.name===h));g&&(i.tilingScheme=new g.tilingScheme({ellipsoid:g.ellipsoid}));const c=r.querySelector("TileFormat"),u=o.find((e=>e.extension==c.getAttribute("extension")));u&&(i.formatImage=u,i.imageSize={width:parseInt(c.getAttribute("width"),10),height:parseInt(c.getAttribute("height"),10)});const f=Array.from(r.querySelectorAll("TileSets>TileSet"));let p=[];if(i.formatImage&&(p=f.map((function(e){let t=e.getAttribute("href")+"/{x}/{tmsY}."+i.formatImage.extension;s&&(t=s.getURL(t));return{url:t,level:parseInt(e.getAttribute("order"))}})),p.sort(((e,t)=>e.level-t.level))),0===p.length||!i.formatImage||!i.tilingScheme)throw new Error("no tilesets, no formatImage and no formatArray");i.URLtemplateImage=function(e,t,r){let i="";return r<p.length&&(i=p[r].url),i};const y=r.querySelector("BoundingBox"),d=parseFloat(y.getAttribute("miny")),x=parseFloat(y.getAttribute("maxy")),S=parseFloat(y.getAttribute("minx")),w=parseFloat(y.getAttribute("maxx")),A=new t.Rectangle(S,d,w,x);return i.getTileDataAvailable=function(e,t,r){const a=i.tilingScheme.tileXYToNativeRectangle(e,t,r);return null!==l(A,a)&&r<n&&r<p.length},i.ready=!0,i}const{fetchXML:f}=t.Resource;function p(e){if(!(e.xml instanceof XMLDocument))throw new Error("xml must be a XMLDocument");if(!e.layerName)throw new Error("description.layerName is required.");const r=e.xml,i={},s=e.layerName,g=e.maxLevel;let c=null;const u={width:65,height:65};let f,p,y;m(e,i),i.formatImage=e.formatImage,i.formatArray=e.formatArray,i.tilingScheme=void 0;let d=e.styleName;const x=r.querySelector("[version]");null!==x&&(c=x.getAttribute("version"),y=/^1\.[3-9]\./.test(c));let S=r.querySelector("Request>GetMap OnlineResource").getAttribute("xlink:href");const w=S.indexOf("?");w>-1&&(S=S.substring(0,w)),e.proxy&&(S=e.proxy.getURL(S));const A=Array.from(r.querySelectorAll("Request>GetMap>Format")).map((e=>e.textContent));for(let t=0;t<A.length;t++)i.formatImage||(i.formatImage=o.find((e=>e.format===A[t]))),i.formatArray||(i.formatArray=n.find((e=>e.format===A[t])));i.formatArray&&"string"==typeof i.formatArray.format&&"function"==typeof i.formatArray.postProcessArray?i.formatArray.terrainDataStructure=Object.assign({},h):delete i.formatArray,i.formatImage&&"string"==typeof i.formatImage.format||(i.formatImage=void 0);const M=r.querySelectorAll("Layer[queryable='1'],Layer[queryable='true']");let b=null;for(let t=0;t<M.length&&null===b;t++)if(M[t].querySelector("Name").textContent===s){b=M[t];let e=b.getAttribute("fixedHeight"),r=b.getAttribute("fixedWidth");null!==e&&(e=parseInt(e,10),i.heightMapHeight=e>0&&e<i.heightMapHeight?e:i.heightMapHeight,u.height=e>0?e:u.height),null!==r&&(r=parseInt(r,10),i.heightMapWidth=r>0&&r<i.heightMapWidth?r:i.heightMapWidth,u.width=r>0?r:u.width)}if(null!==b&&null!==c){let e=!1;for(let r=0;r<a.length&&!e;r++){const o=a[r],n=o.name,s=b.querySelector("BoundingBox[SRS='"+n+"'],BoundingBox[CRS='"+n+"']");if(null!==s){let r,a,h,m;f=n,p=o.firstAxeIsLatitude,i.tilingScheme=new o.tilingScheme({ellipsoid:o.ellipsoid}),p&&y?(r=parseFloat(s.getAttribute("miny")),a=parseFloat(s.getAttribute("maxy")),h=parseFloat(s.getAttribute("minx")),m=parseFloat(s.getAttribute("maxx"))):(r=parseFloat(s.getAttribute("minx")),a=parseFloat(s.getAttribute("maxx")),h=parseFloat(s.getAttribute("miny")),m=parseFloat(s.getAttribute("maxy")));const c=new t.Rectangle(r,h,a,m);i.getTileDataAvailable=function(e,t,r){let a=!1,o=i.tilingScheme.tileXYToNativeRectangle(e,t,r);if(r<g){a=null!==l(c,o)}return a},e=!0}}if(d){const e=b.querySelectorAll("Style>Name");let t=!1;for(let r=0;r<e.length&&!t;r++)d===e[r].textContent&&(t=!0);t||(d=null)}const o=r.querySelectorAll("VendorSpecificCapabilities>TileSet");let n=!1;for(let t=0;t<o.length&&!n;t++){const e=null!==o[t].querySelector("BoundingBox[SRS='"+f+"'],BoundingBox[CRS='"+f+"']");o[t].querySelector("Layers").textContent===s&&e&&(u.width=parseInt(o[t].querySelector("Width").textContent,10),u.height=parseInt(o[t].querySelector("Height").textContent,10),n=!0)}i.ready=e&&(i.formatImage||i.formatArray)&&null!==c}if(i.ready){let e=S+"?SERVICE=WMS&REQUEST=GetMap&layers="+s+"&version="+c+"&bbox=";if(e+=y&&p?"{south},{west},{north},{east}":"{west},{south},{east},{north}",e+="&crs="+f+"&srs="+f,i.formatImage){let t=e+"&format="+i.formatImage.format+"&width="+u.width+"&height="+u.height;d&&(t+="&styles="+d+"&style="+d),i.URLtemplateImage=()=>t,i.imageSize=u}if(i.formatArray){const t=e+"&format="+i.formatArray.format+"&width="+i.heightMapWidth+"&height="+i.heightMapHeight;i.URLtemplateArray=()=>t}}return i}const{fetchXML:y}=t.Resource;function d(e){const t=e.xml;if(!(t instanceof XMLDocument))throw new Error("xml must be a XMLDocument");const r={},i=e.layerName;m(e,r);const l=e.maxLevel,n=e.proxy;let s=e.styleName,h=null,g=[],c=null,u=null,f=null;Array.from(t.querySelectorAll('Operation[name="GetTile"] HTTP Get')).map((e=>({node:e,type:e.querySelector("Value").textContent}))).forEach((e=>{"RESTful"===e.type&&null===u&&(u=e.node.getAttribute("xlink:href"),n&&(u=n.getURL(u))),"KVP"===e.type&&null===c&&(c=e.node.getAttribute("xlink:href"),n&&(c=n.getURL(c)))}));const p=t.querySelectorAll("Contents>Layer>Identifier");let y=null;for(let a=0;a<p.length&&null===y;a++)i===p[a].textContent&&(y=p[a].parentNode);if(null!==y){let e=null,t=null;Array.from(y.querySelectorAll("Style")).forEach((r=>{const i=r.querySelector("Identifier").textContent;null!=r.getAttribute("isDefault")&&(e=i),i===s&&(t=i)})),s&&s===t||(s=e||"");const r=Array.from(y.querySelectorAll("Format"));for(let i=0;i<o.length&&null===f;i++){r.filter((e=>e.textContent===o[i].format)).length>0&&(f=o[i])}g=Array.from(y.querySelectorAll("TileMatrixSetLink"))}const d=Array.from(t.querySelectorAll("TileMatrixSet>Identifier"));for(let o=0;o<g.length&&!r.ready;o++){const e=g[o],t=e.querySelector("TileMatrixSet").textContent;let n=null,m=null;for(let r=0;r<d.length&&null===n;r++)d[r].textContent===t&&(n=d[r].parentNode);const u=n.querySelector("SupportedCRS").textContent;for(let r=0;r<a.length&&null===m;r++)a[r].supportedCRS===u&&(m=a[r]);if(null!==m){const a=Array.from(n.querySelectorAll("TileMatrix")).map((function(e){let t=e.querySelector("Identifier").textContent,r=parseInt(e.querySelector("MatrixWidth").textContent,10),i=parseInt(e.querySelector("MatrixHeight").textContent,10),l=parseInt(e.querySelector("TileWidth").textContent,10),a=parseInt(e.querySelector("TileHeight").textContent,10);return{id:t,maxWidth:r,maxHeight:i,scaleDenominator:parseFloat(e.querySelector("ScaleDenominator").textContent),complete:!1,tileWidth:l,tileHeight:a}})).sort(((e,t)=>t.scaleDenominator-e.scaleDenominator)),o=Array.from(e.querySelectorAll("TileMatrixSetLimits>TileMatrixLimits")).map((e=>({id:e.querySelector("TileMatrix").textContent,bbox:{minTileRow:parseInt(e.querySelector("MinTileRow").textContent,10),maxTileRow:parseInt(e.querySelector("MaxTileRow").textContent,10),minTileCol:parseInt(e.querySelector("MinTileCol").textContent,10),maxTileCol:parseInt(e.querySelector("MaxTileCol").textContent,10)}})));if(a.forEach((e=>{o.forEach((t=>{e.id===t.id&&(e.bbox=t.bbox,e.complete=!0)}))})),a.length>0){r.tilingScheme=new m.tilingScheme({ellipsoid:m.ellipsoid,numberOfLevelZeroTilesX:a[0].maxWidth,numberOfLevelZeroTilesY:a[0].maxHeight});const e=y.querySelector("ResourceURL[format='"+f.format+"']");if(null!==e?h=e.getAttribute("template").replace("{TileRow}","{y}").replace("{TileCol}","{x}").replace("{style}",s).replace("{Style}",s).replace("{TileMatrixSet}",t).replace("{layer}",i).replace("{infoFormatExtension}",f.extension):null!==c&&(h=c+"service=WMTS&request=GetTile&version=1.0.0&layer="+i+"&style="+s+"&format="+f.format+"&TileMatrixSet="+t+"&TileMatrix={TileMatrix}&TileRow={y}&TileCol={x}"),null!==h){r.getTileDataAvailable=(e,t,r)=>{let i=!1;if(r<l&&r<a.length){const l=a[r],o=l.bbox;i=l.complete?t<=o.maxTileRow&&t>=o.minTileRow&&e<=o.maxTileCol&&e>=o.minTileCol:e<l.maxWidth&&t<l.maxHeight}return i},r.URLtemplateImage=function(e,t,i){let l="";if(r.getTileDataAvailable(e,t,i)){let e=a[i];l=h.replace("{TileMatrix}",e.id)}return l};const e={width:a[0].tileWidth,height:a[0].tileHeight};0===a.filter((t=>t.tileWidth!=e.width||t.tileHeight!=e.height)).length&&(r.imageSize=e),r.ready=!0}}}}return r}let x=class{constructor(e,r=""){i(this,"errorEvent",new t.Event),i(this,"credit"),i(this,"tilingScheme"),i(this,"ready",!1),i(this,"hasVertexNormals",!1),i(this,"readyPromise"),i(this,"hasWaterMask"),i(this,"heightMapHeight"),i(this,"heightMapWidth"),i(this,"availability"),this.credit=new t.Credit(r),this.tilingScheme=e.tilingScheme,this.getTileDataAvailable=e.getTileDataAvailable,this.hasWaterMask=!1,this.heightMapHeight=e.heightMapHeight,this.heightMapWidth=e.heightMapWidth,this.availability=new t.TileAvailability(this.tilingScheme,e.maximumLevel),this.getLevelMaximumGeometricError=t=>e.levelZeroMaximumGeometricError/(1<<t),this.requestTileGeometry=async(r,i,l)=>{const a=await e.GeometryCallback(r,i,l),o=function(e,t,r,i){let l=0,a=r+1;return l|=i.getTileDataAvailable(2*e,2*t,a)?1:0,l|=i.getTileDataAvailable(2*e+1,2*t,a)?2:0,l|=i.getTileDataAvailable(2*e,2*t+1,a)?4:0,l|=i.getTileDataAvailable(2*e+1,2*t+1,a)?8:0,l}(r,i,l,e);return new t.HeightmapTerrainData({buffer:a,width:e.heightMapWidth,height:e.heightMapHeight,childTileMask:o})},this.ready=e.ready,this.readyPromise=new Promise((e=>!0))}requestTileGeometry(e,t,r,i){throw new Error("Method not implemented.")}getLevelMaximumGeometricError(e){throw new Error("Method not implemented.")}getTileDataAvailable(e,t,r){throw new Error("Method not implemented.")}loadTileDataAvailability(e,t,r){throw new Error("Method not implemented.")}};const{fetchArrayBuffer:S,fetchImage:w}=t.Resource;async function A(e){let r;switch((e=Object.assign(s,e)).service){case"TMS":r=async function(e){let t;if(e.url)e.xml=await g({url:e.url+"/gwc/service/tms/1.0.0"}),t=await c(e);else{if(!e.xml)throw new Error("either description.url or description.xml are required.");t=await c(e)}return t}(e);break;case"WMTS":r=async function(e){let t;if(e.url){let r=e.url;const i=r.lastIndexOf("?");i>-1&&(r=r.substring(0,i));let l=r+"/gwc/service/wmts?REQUEST=GetCapabilities";e.proxy&&(l=e.proxy.getURL(l)),console.log(l),e.xml=await y({url:l}),t=d(e)}else{if(!e.xml)throw new Error("either description.url or description.xml are required.");t=d(e)}return t}(e);break;default:r=async function(e){let t;if(e.url){let r=e.url,i=r.lastIndexOf("?");i>-1&&(r=r.substring(0,i));let l=r+"/ows?SERVICE=WMS&REQUEST=GetCapabilities&tiled=true";console.log(l),e.proxy&&(l=e.proxy.getURL(l)),e.xml=await f({url:l}),t=p(e)}else{if(!e.xml)throw new Error("either description.url or description.xml are required.");t=p(e)}return t}(e)}const i=await r;return M(i),"WMTS"===e.service?new x(i):new t.CustomHeightmapTerrainProvider({height:i.heightMapHeight,width:i.heightMapWidth,tilingScheme:i.tilingScheme,callback:i.GeometryCallback})}function M(e){e.levelZeroMaximumGeometricError=t.TerrainProvider.getEstimatedLevelZeroGeometricErrorForAHeightmap(e.tilingScheme.ellipsoid,e.heightMapWidth,e.tilingScheme.getNumberOfXTilesAtLevel(0)),e.URLtemplateImage&&(e.getBufferImage=async(r,i,l)=>{let a=null;if(!isNaN(r+i+l)){const o=b(e.URLtemplateImage(r,i,l),r,i,l,e),n={highest:e.highest,lowest:e.lowest,offset:e.offset};let s=w({url:o});a=await s.then((r=>function(e,r,i,l){const a=t.getImagePixels(e,i.width,i.height),o=new Int16Array(a.length/4);let n=0,s=0;for(let t=0;t<a.length;t+=4){const e=a[t],i=a[t+1],h=a[t+2]>128,m=(e<<8|i)-r.offset-32768;m>r.lowest&&m<r.highest&&(h||l)?(o[t/4]=m,s+=m,n++):o[t/4]=0===n?0:s/n}return o}(r,n,{width:e.heightMapWidth,height:e.heightMapHeight},e.hasStyledImage))).catch((()=>new Int16Array(e.heightMapWidth*e.heightMapHeight)))}return a}),e.URLtemplateArray&&(e.getBufferArray=async(t,r,i)=>{let l=null;if(!isNaN(t+r+i)){const a=b(e.URLtemplateArray(t,r,i),t,r,i,e),o={highest:e.highest,lowest:e.lowest,offset:e.offset};let n=S({url:a});l=await n.then((t=>function(e,t,r,i){return i.postProcessArray(e,r,t.highest,t.lowest,t.offset)}(t,o,{width:e.heightMapWidth,height:e.heightMapHeight},e.formatArray))).catch((()=>new Int16Array(e.heightMapWidth*e.heightMapHeight)))}return l}),e.GeometryCallback=async(t,r,i)=>{let l;return e.getBufferArray?l=await e.getBufferArray(t,r,i):e.getBufferImage&&(l=await e.getBufferImage(t,r,i)),l}}function b(e,t,r,i,l){const a=l.tilingScheme.tileXYToNativeRectangle(t,r,i),o=(a.east-a.west)/(l.heightMapWidth-1),n=(a.north-a.south)/(l.heightMapHeight-1);a.west-=.5*o,a.east+=.5*o,a.south-=.5*n,a.north+=.5*n;const s=l.tilingScheme.getNumberOfYTilesAtLevel(i)-r-1;return e.replace("{south}",a.south.toString()).replace("{north}",a.north.toString()).replace("{west}",a.west.toString()).replace("{east}",a.east.toString()).replace("{x}",t.toString()).replace("{y}",r.toString()).replace("{tmsY}",s.toString())}return window.Cesium.GeoserverTerrainProvider=A,e.TerrainParser=M,e.default=A,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}}),e}({},cesium);
